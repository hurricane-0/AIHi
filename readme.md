## 项目概述

基于 ESP32-S3 的智能硬件平台，集成大规模语言模型（LLM）能力，提供“对话模式”和“高级模式”两种工作状态。设备可通过网页界面或嵌入式 OLED 与按键实现人机交互，并具备自主任务规划与执行、USB HID 电脑控制、Wi-Fi 与蓝牙外设互联等功能。

---

## 1. 功能模块

### 1.1通信与交互

- **嵌入式 Web 服务器**：运行于 ESP32-S3，托管静态资源（HTML/CSS/JS），构建响应式用户界面。

- **WebSocket 服务器**：提供实时、双向通信通道，实现移动端网页与设备的数据交互。

- **USB 模拟串口网页托管**：在特定工作模式下，可通过 USB 接口模拟串口与网页前端交互，实现脱离 Wi-Fi 环境下的配置与控制。

- **OLED 与按键接口**：图形化 GUI 结合三枚按键，用于在无网络环境下查看状态及触发预设自动化指令。

### 1.2 人工智能

- **LLM 集成**：支持 DeepSeek、Gemini、ChatGPT 等多种大模型，用户可动态切换。
- **会话模式**：自然语言对话接口，简洁热情的应答风格，适合即时交互场景。
- **高级模式**：基于自然语言指令，LLM（大语言模型）可进行任务规划与自动化执行。在此模式下，LLM能够通过**函数调用（Function Calling）**机制，调用设备授权的特定外设功能模块或用户自定义的自动化脚本，完成复杂操作。

### 1.3 任务自动化

- **模块化指令（自动化脚本）**：用户可通过网页界面预定义一系列操作步骤，封装成可复用的自动化脚本（例如：通过USB HID操作PC配置C++环境、文件管理等）。这些脚本以JSON格式存储于SD卡中，用户可在网页界面或嵌入式OLED界面直接调用。
- **LLM调用自动化模块**：在高级模式下，LLM可以识别用户意图，并以结构化的方式（通过函数调用）请求执行用户已设置并授权的自动化模块。

### 1.4 外设功能控制
这些功能模块在网页界面中展示，用户可通过网页界面直接控制和调用。同时，它们也可以被**临时授权**给LLM在高级模式下调用，以实现更复杂的自动化流程。授权状态不进行持久化存储。

- **USB HID**：模拟键盘与鼠标事件，实现文本输入、快捷键操作、系统级控制（打开/关闭应用、文件管理、屏幕截图等）。
- **Wi-Fi Killer模式**：提供网络探测与调试能力。
- **蓝牙通信**：BLE 设备扫描、连接与串口模拟，扩展无线外设交互。
- **Timer**：通过调用单片机定时器进行定时和计时。
- **GPIO**：可以控制 `hardwave.md` 中定义的Reserved 1，2引脚的高低电平。
---

## 2. 硬件架构

- **主控芯片**：ESP32-S3，丰富外设接口。
- **存储**：MicroSD 卡，用于存储网络配置、API Key、自动化脚本等。
- **显示**：0.96" OLED（I2C，驱动为SSD1315），用于实时状态与菜单导航。
- **按键**：3×物理按键（OK/上下），实现菜单切换与功能确认。
- **指示灯**：用于反馈设备状态与错误提示。
- **接口**：USB Type-C（HID 模式）、Wi-Fi（2.4GHz）、BLE。

具体硬件配置请查看hardwave.md文件。

---

## 3. 软件架构

### 3.1 系统平台

- **开发框架**：Arduino ，使用platformIO配置环境。

### 3.2 驱动与中间件

- **硬件抽象层**：封装 GPIO、I2C、SPI、USB HID 驱动。
- **网络协议栈**：LWIP TCP/IP，支持 HTTPS（mbedTLS）和 WebSocket。
- **文件系统**：SPIFFS/SD 库，用于配置与脚本存储。

### 3.3 服务与模块

- **WebServer 模块**：静态文件服务与 REST API。
- **WebSocket 模块**：事件广播与命令下发。
- **LLM 接口层**：统一请求封装，支持多模型切换与负载均衡。
- **任务管理器**：指令解析、状态跟踪与并发执行。
- **HID 控制器**：事件映射与日志记录。

---

## 4. 交互界面设计

### 4.1 网页端（Mobile Web UI）

- **设计风格**：扁平化、圆角布局，配色简洁。
- **顶栏**：毛玻璃效果，左侧项目名称（黑体），右侧工作模式切换与设置按钮（点击后左侧弹出侧栏，可以增删网络信息（名称密码）和API key。（储存与SD卡）。
- **聊天窗口**：3:2 比例，滚动对话记录。
- **输入区**：文本输入框 + 文件/图片上传。
- **双模式接入**：网页界面既可通过 Wi-Fi 网络访问 ESP32-S3 上托管的网页，也支持通过 USB 模拟串口接口提供本地网页界面，无需网络环境即可访问与操作核心功能。



当切换至高级模式下，除了以上组件，界面还包括:

- **高级功能区**：
  1. **功能面板**：竖向排列，包含各功能模块，右侧排列AUTO按钮（启用后LLM即可使用该功能）与→按钮（点击后进入该功能选项详细界面）
  2. **自动化指令面板**：横向双列排列，支持创建、删除、运行脚本。

### 4.2 OLED GUI

- **主界面**：显示当前时间、网络状态、IP 地址。
- **菜单界面**：双击 OK 键进入，按上下键导航：Settings、Wi‑Fi Killer、定时器、Auto（自定义脚本）。
- **脚本执行**：在 Auto 菜单下选中脚本并确认，执行状态实时反馈。

---

## 5. 开发与集成指南

1.  **功能抽象与LLM函数调用**：将设备的外设功能和自动化脚本抽象为清晰的函数或工具，并为其定义详细的JSON Schema描述。这些描述将被整合到LLM的系统提示词中，以便LLM理解并以结构化的函数调用（Function Calling）格式返回执行指令。
2.  **动态系统提示词**：在发送用户指令给LLM前，根据当前的工作模式（对话模式/高级模式）和用户授权的工具列表，动态拼接设备能力列表与当前状态作为LLM的系统提示。
3.  **自动化脚本规范**：自动化脚本须遵循统一的JSON格式规范（例如包含 `tool_name` 和 `parameters` 的步骤序列），以便 `TaskManager` 能够解析、执行并提供状态回调。
